<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BDO Dashboard | PM-AJAY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use the 'dark' class for dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <!-- Leaflet.js Script -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            background-color: #ffffff;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        /* Dark mode specific card styles */
        .dark .card {
            background-color: #1c1b1a;
            border: 1px solid #374151; /* gray-700 */
            box-shadow: none;
        }
        .dark .card:hover {
            background-color: #2c2b2a;
        }
        /* Active sidebar link style */
        .nav-link.active {
            @apply bg-indigo-50 dark:bg-white text-slate-900 font-semibold;
        }
        /* This now targets the SVG icon that lucide creates */
        .nav-link.active svg {
             @apply text-indigo-600;
        }
        
        /* Action Pane & Dossier Transition */
        #action-pane, #village-dossier-container, #map-dossier-pane, #officer-dossier-container {
            transition: transform 0.3s ease-in-out;
        }

        /* Dossier Tab Styling */
        .dossier-tab.active-tab {
            @apply text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600;
        }

        .leaflet-control-attribution {
            font-size: 10px !important;
        }
        
        @keyframes bounce { 
            0%, 100% { transform: translateY(0); } 
            50% { transform: translateY(-10px); } 
        }
        .bouncing-marker { 
            animation: bounce 1s infinite; 
        }

        /* Comm Hub Channel Active State */
        .channel-link.active {
            @apply bg-indigo-100 dark:bg-indigo-900/50 font-semibold;
        }

    </style>
</head>
<body class="bg-[#fdfaf6] dark:bg-black">
    <div class="relative min-h-screen md:flex">
        <!-- Mobile Nav Toggle -->
        <div class="flex justify-between md:hidden p-4 bg-white dark:bg-[#1c1b1a] border-b border-slate-200 dark:border-gray-700">
             <h1 class="text-xl font-bold text-slate-800 dark:text-gray-100 flex items-center">PM-AJAY</h1>
            <button id="sidebar-toggle" class="text-slate-600 dark:text-gray-300 hover:text-indigo-600">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="w-64 flex-shrink-0 border-r border-slate-200 dark:border-gray-700 flex flex-col bg-white dark:bg-[#1c1b1a] fixed inset-y-0 left-0 z-40 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-6 hidden md:block">
                <h1 class="text-2xl font-bold text-slate-800 dark:text-gray-100 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2 text-indigo-600" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.874 6 7.5 6h5c.626 0 .988-.27 1.256-.579A6.012 6.012 0 0115.668 8.027c.21.34.332.732.332 1.155a3.999 3.999 0 01-4 4c-1.933 0-3.5-1.567-3.5-3.5a3.999 3.999 0 011.006-2.622c.23-.352.484-.65.744-.897C10.5 6.27 10.246 6 10 6h-.5a.5.5 0 00-.5.5v1.5a.5.5 0 00.5.5h.5a.5.5 0 00.5-.5v-1a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v1a.5.5 0 00.5.5h.5a.5.5 0 00.5-.5V8.5a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v1.5a.5.5 0 00.5.5H8a.5.5 0 00.5-.5V9.5a3.5 3.5 0 00-3.5-3.5c-.538 0-1.03.123-1.468.342z" clip-rule="evenodd" />
                    </svg>
                    PM-AJAY
                </h1>
            </div>
            <nav id="sidebar-nav" class="flex-1 px-4 py-2">
                <a href="#" id="dashboard-link" class="nav-link flex items-center px-4 py-2.5 rounded-lg">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                    Dashboard
                </a>
                <a href="#" id="inbox-link" class="nav-link flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium">
                    <i data-lucide="inbox" class="w-5 h-5 mr-3"></i>
                    Inbox / Tasks
                </a>
                <a href="#" id="villages-link" class="nav-link flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium">
                    <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                    Villages
                </a>
                <a href="#" id="map-link" class="nav-link flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium">
                    <i data-lucide="map" class="w-5 h-5 mr-3"></i>
                    Block Map (GIS)
                </a>
                <a href="#" id="team-link" class="nav-link flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    Team Performance
                </a>
                <a href="#" id="comm-link" class="nav-link flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium">
                    <i data-lucide="message-square" class="w-5 h-5 mr-3"></i>
                    Communication Hub
                </a>
                 <a href="#" id="reports-link" class="nav-link flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium">
                    <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                    Reports
                </a>
            </nav>
            <div class="p-4 mt-auto">
                 <div class="bg-slate-100 dark:bg-gray-800 rounded-lg p-4 text-center">
                    <i data-lucide="help-circle" class="w-10 h-10 mx-auto text-slate-500 dark:text-gray-400"></i>
                    <p class="text-sm text-slate-600 dark:text-gray-300 mt-2">Need help with the portal?</p>
                    <button id="contact-support-btn" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700 dark:hover:bg-indigo-500">Contact Support</button>
                </div>
                <a href="./login.html" class="flex items-center px-4 py-4 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-4 font-medium">
                    <i data-lucide="log-out" class="w-5 h-5 mr-3"></i>
                    Sign Out
                </a>
            </div>
        </aside>

        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-4 sm:p-6 lg:p-8">
            <!-- Content will be dynamically rendered here -->
        </main>
        
        <!-- Action Pane (Modal/Side Panel) -->
        <div id="action-pane-container" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden">
             <div id="action-pane" class="fixed top-0 right-0 h-full w-full max-w-lg bg-white dark:bg-[#1c1b1a] shadow-2xl transform translate-x-full z-50 overflow-y-auto">
                <div id="action-pane-content" class="p-6">
                    <!-- Action-specific content will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Village Dossier (Full Screen Modal) -->
        <div id="village-dossier-container" class="fixed inset-0 bg-white dark:bg-black z-50 transform translate-y-full overflow-y-auto">
            <div id="village-dossier-content" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">
                <!-- Dossier content will be rendered here -->
            </div>
        </div>
        
        <!-- Officer Dossier (Full Screen Modal) -->
        <div id="officer-dossier-container" class="fixed inset-0 bg-white dark:bg-black z-50 transform translate-y-full overflow-y-auto">
            <div id="officer-dossier-content" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">
                <!-- Officer Dossier content will be rendered here -->
            </div>
        </div>

        <!-- Report & Support Modals -->
        <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center">
            <div id="modal-content" class="bg-white dark:bg-[#1c1b1a] rounded-lg shadow-xl p-6 w-full max-w-md">
                 <!-- Modal content will be rendered here -->
            </div>
        </div>

    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const mainContent = document.getElementById('main-content');
            const navLinks = document.querySelectorAll('.nav-link');
            let pipelineChart;
            let officerCharts = {};
            let isDarkMode = false;
            let map, currentTileLayer;
            let tourStops = [];
            let isTourPlanningActive = false;
            
            // --- API KEYS ---
            const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY"; // Placeholder for Gemini API Key
            
            // --- Gemini API Simulation ---
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;

            async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
                console.log("Simulating Gemini API call for prompt:", prompt);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const promptText = prompt.contents[0].parts[0].text;
                if (promptText.includes("Task Inbox")) {
                     return { candidates: [{ content: { parts: [{ text: JSON.stringify([
                        { id: 1, type: "VDP Review", village: "Rampur", submittedBy: "F.O. Sunil Kumar", date: "11-Oct-2025", aiScore: 95, aiSummary: "All data present. Ready for review." },
                        { id: 2, type: "GIA Beneficiary List", village: "Gopalganj", submittedBy: "F.O. Sunil Kumar", date: "08-Oct-2025", aiScore: 72, aiSummary: "Budget mismatch. Missing household data." },
                        { id: 3, type: "Milestone Photo", village: "Sitapur", submittedBy: "F.O. Anita Singh", date: "10-Oct-2025", aiScore: 65, aiSummary: "Image unclear. Potential geo-tag mismatch." }
                    ])}]}}]};
                }
                 if (promptText.includes("AI Root Cause Analysis")) {
                     return { candidates: [{ content: { parts: [{ text: JSON.stringify(
                        { analysis: "Sunil Kumar's Data Quality score is low because 4 of his last 5 VDP submissions were returned. The common error is 'incomplete household data for beneficiary-oriented schemes'.",
                          recommendation: "Assign the 5-minute video tutorial: 'Best Practices for Capturing Format III-A Data'. This directly addresses his most common mistake."
                        })}]}}]};
                }
                if (promptText.includes("Village Health")) {
                     return { candidates: [{ content: { parts: [{ text: JSON.stringify({
                        onTrack: { count: 65, alert: "2 villages showing signs of delay" },
                        minorDelays: { count: 9, alert: "1 village at high risk of moving to Critical" },
                        criticalDelays: { count: 4, alert: null }
                    })}]}}]};
                }
                if (promptText.includes("AI Opportunities")) {
                    return { candidates: [{ content: { parts: [{ text: JSON.stringify([
                        { title: "High demand for tailoring skills", details: "in Rampur & Sitapur villages.", type: "GIA" },
                        { title: "Significant dropout rate", details: "due to lack of accommodation in Pusa block.", type: "Hostel" }
                    ])}]}}]};
                }
                if (promptText.includes("Field Team Pulse")) {
                     return { candidates: [{ content: { parts: [{ text: JSON.stringify([
                         { officer: "F.O. Sunil Kumar", alert: "Submission rate dropped 20% this month.", type: "warning" },
                         { officer: "F.O. Anita Singh", alert: "High rate of VDPs returned for correction.", type: "critical" },
                         { officer: "Team Alert", alert: "Survey completion for northern cluster is 15% behind.", type: "info" }
                    ])}]}}]};
                }
                return { candidates: [{ content: { parts: [{ text: "[]" }] } }] };
            }

            // --- PAGE RENDERING FUNCTIONS ---
            
            function renderDashboard() {
                mainContent.innerHTML = `
                    <!-- Header -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-gray-100">Block Level Dashboard</h2>
                            <p class="text-slate-500 dark:text-gray-400 mt-1 text-sm sm:text-base">Your AI-Powered Command Center</p>
                        </div>
                        <div class="flex items-center mt-4 sm:mt-0 w-full sm:w-auto justify-end">
                            <div class="flex items-center space-x-2">
                                <button class="flex items-center justify-center gap-2 bg-red-50 text-red-600 dark:bg-red-500/10 dark:text-red-400 font-semibold px-3 py-2 rounded-lg text-sm hover:bg-red-100 dark:hover:bg-red-500/20"><i data-lucide="siren" class="w-4 h-4"></i><span class="hidden sm:inline">Escalate Issue</span></button>
                                <button class="flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold px-3 py-2 rounded-lg text-sm hover:bg-indigo-700 dark:hover:bg-indigo-500"><i data-lucide="plus" class="w-4 h-4"></i><span class="hidden sm:inline">Propose Project</span></button>
                                <div class="relative"><button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="bell" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i><span class="absolute top-1 right-1 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white dark:ring-black"></span></button></div>
                                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="sun" id="theme-toggle-light-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i><i data-lucide="moon" id="theme-toggle-dark-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400 hidden"></i></button>
                            </div>
                            <div class="hidden sm:flex items-center ml-4"><img src="https://placehold.co/40x40/E2E8F0/475569?text=AV" alt="BDO Alok Verma" class="w-10 h-10 rounded-full"><div class="ml-3"><p class="font-semibold text-slate-800 dark:text-gray-100">Mr. Alok Verma</p><p class="text-sm text-slate-500 dark:text-gray-400">BDO, Pusa Block</p></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"><div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Pending Verifications</h3><p class="text-4xl font-bold text-slate-800 dark:text-gray-100 mt-2">12</p><p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Awaiting your action</p></div><div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Villages: Critical Status</h3><p class="text-4xl font-bold text-red-600 dark:text-red-500 mt-2">4</p><p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Require immediate intervention</p></div><div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Projects Delayed</h3><p class="text-4xl font-bold text-slate-800 dark:text-gray-100 mt-2">7</p><p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Past expected milestone date</p></div><div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Issues Escalated</h3><p class="text-4xl font-bold text-slate-800 dark:text-gray-100 mt-2">2</p><p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Pending at District Level</p></div></div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-6"><div class="card lg:col-span-3 p-5"><h3 class="text-lg font-semibold text-slate-800 dark:text-gray-100 mb-4">VDP & Proposal Pipeline</h3><div style="height: 320px;"><canvas id="pipelineChart"></canvas></div></div><div class="lg:col-span-2 flex flex-col gap-6"><div class="card p-5"><h3 class="text-lg font-semibold text-slate-800 dark:text-gray-100 mb-3">Village Health Status</h3><div id="village-health-status" class="space-y-3"></div></div><div class="card p-5"><h3 class="text-lg font-semibold text-slate-800 dark:text-gray-100 mb-3">AI-Identified Opportunities</h3><div id="ai-opportunities" class="space-y-3"></div></div></div></div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6"><div class="card lg:col-span-2 p-5"><h3 class="text-lg font-semibold text-slate-800 dark:text-gray-100 mb-4">My Task Inbox: Pending Verifications</h3><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="text-xs text-slate-500 dark:text-gray-400 uppercase bg-slate-50 dark:bg-gray-800"><tr><th scope="col" class="px-6 py-3">Task / Village</th><th scope="col" class="px-6 py-3">Submitted By</th><th scope="col" class="px-6 py-3">AI Quality Score</th><th scope="col" class="px-6 py-3 text-center">Action</th></tr></thead><tbody id="task-inbox-body"></tbody></table></div></div><div class="card p-5"><h3 class="text-lg font-semibold text-slate-800 dark:text-gray-100 mb-3">Field Team Pulse</h3><div id="team-pulse" class="space-y-3"></div></div></div>
                `;
                attachThemeToggleListener();
                populateDashboardData();
            }
            
            function renderInboxTasks() {
                mainContent.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6"><div><h2 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-gray-100">Inbox / Tasks</h2><p class="text-slate-500 dark:text-gray-400 mt-1 text-sm sm:text-base">This is not an email client. This is a command queue.</p></div><div class="flex items-center mt-4 sm:mt-0 w-full sm:w-auto justify-end"><button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="sun" id="theme-toggle-light-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i><i data-lucide="moon" id="theme-toggle-dark-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400 hidden"></i></button></div></div>
                    <div class="card p-4 mb-6"><div class="flex flex-wrap items-center gap-4"><div class="flex items-center gap-2"><button class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg">All Tasks</button><button class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-gray-200 bg-white dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg">New / Unread</button><button class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-gray-200 bg-white dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg">Awaiting My Action</button><button class="px-4 py-2 text-sm font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-500/10 border border-red-200 dark:border-red-500/30 rounded-lg">High Priority</button></div><div class="flex-grow border-t sm:border-t-0 sm:border-l border-slate-200 dark:border-gray-700 sm:ml-4 sm:pl-4 flex flex-wrap items-center gap-4"><select class="bg-slate-50 dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg text-sm p-2"><option>Filter by Type</option></select><select class="bg-slate-50 dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg text-sm p-2"><option>Filter by Village</option></select><select class="bg-slate-50 dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg text-sm p-2"><option>Filter by Status</option></select><select class="bg-slate-50 dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg text-sm p-2"><option>Sort By: Newest First</option></select></div></div></div>
                    <div class="card"><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="text-xs text-slate-500 dark:text-gray-400 uppercase bg-slate-50 dark:bg-gray-800"><tr><th scope="col" class="px-6 py-3">AI Score / Priority</th><th scope="col" class="px-6 py-3">Task Type</th><th scope="col" class="px-6 py-3">Subject / Village</th><th scope="col" class="px-6 py-3">From</th><th scope="col" class="px-6 py-3">Date Received</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3">Action</th></tr></thead><tbody id="inbox-task-body"></tbody></table></div></div>
                    <div class="flex justify-end mt-4"><button class="flex items-center gap-2 bg-green-600 text-white font-semibold px-4 py-2 rounded-lg text-sm hover:bg-green-700"><i data-lucide="sheet" class="w-4 h-4"></i> Export to Sheets</button></div>
                `;
                populateInboxTasks();
                attachThemeToggleListener();
            }

            function renderVillages() {
                mainContent.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6"><div><h2 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-gray-100">Villages</h2><p class="text-slate-500 dark:text-gray-400 mt-1 text-sm sm:text-base">Triage, Prioritize, Act.</p></div><div class="flex items-center mt-4 sm:mt-0 w-full sm:w-auto justify-end"><button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="sun" id="theme-toggle-light-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i><i data-lucide="moon" id="theme-toggle-dark-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400 hidden"></i></button></div></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6"><div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Total Villages</h3><p class="text-4xl font-bold text-slate-800 dark:text-gray-100 mt-2">78</p></div><div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Adarsh Grams Declared</h3><p class="text-4xl font-bold text-green-600 dark:text-green-500 mt-2">12</p></div><div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Villages in Critical Status</h3><p class="text-4xl font-bold text-red-600 dark:text-red-500 mt-2">4</p></div><div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Villages with Pending VDPs</h3><p class="text-4xl font-bold text-yellow-600 dark:text-yellow-500 mt-2">9</p></div></div>
                    <div class="card p-4 mb-6"><div class="flex flex-wrap items-center justify-between gap-4"><div class="flex-grow max-w-sm"><div class="relative"><i data-lucide="search" class="w-4 h-4 absolute top-1/2 left-3 -translate-y-1/2 text-slate-400"></i><input type="text" placeholder="Search for a village..." class="w-full bg-slate-50 dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg text-sm p-2 pl-9"></div></div><div class="flex items-center gap-2 flex-wrap"><button class="px-3 py-1.5 text-sm font-medium text-slate-700 dark:text-gray-200 bg-slate-100 dark:bg-gray-700 rounded-lg">All</button><button class="px-3 py-1.5 text-sm font-medium text-red-700 dark:text-red-300 bg-red-100 dark:bg-red-900/50 rounded-lg">Critical (4)</button><button class="px-3 py-1.5 text-sm font-medium text-yellow-700 dark:text-yellow-300 bg-yellow-100 dark:bg-yellow-900/50 rounded-lg">Delayed (9)</button><button class="px-3 py-1.5 text-sm font-medium text-green-700 dark:text-green-300 bg-green-100 dark:bg-green-900/50 rounded-lg">On Track (65)</button><button class="px-3 py-1.5 text-sm font-medium text-indigo-700 dark:text-indigo-300 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg">VDP Pending (9)</button></div><div><select class="bg-slate-50 dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg text-sm p-2"><option>Sort by: Performance (Low to High)</option><option>Sort by: Name (A-Z)</option><option>Sort by: Last Update</option></select></div></div></div>
                    <div id="village-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                `;
                populateVillageGrid();
                attachThemeToggleListener();
            }
            
            function renderBlockMap() {
                 mainContent.innerHTML = `
                    <div class="h-full flex flex-col">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                            <div>
                                <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-gray-100">Block Map (GIS)</h2>
                                <p class="text-slate-500 dark:text-gray-400 mt-1 text-sm sm:text-base">Geospatial Intelligence Platform</p>
                            </div>
                            <div class="flex items-center mt-4 sm:mt-0">
                                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                                    <i data-lucide="sun" id="theme-toggle-light-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i>
                                    <i data-lucide="moon" id="theme-toggle-dark-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400 hidden"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex-grow flex flex-col md:flex-row gap-4 relative overflow-hidden">
                            <!-- Control Panel -->
                            <div class="w-full md:w-80 flex-shrink-0 bg-white dark:bg-[#1c1b1a] rounded-lg shadow-md p-4 overflow-y-auto">
                                <h3 class="font-bold text-lg text-slate-800 dark:text-gray-100 mb-4">Map Controls</h3>
                                <div class="relative mb-4"><i data-lucide="search" class="w-4 h-4 absolute top-1/2 left-3 -translate-y-1/2 text-slate-400"></i><input type="text" placeholder="Search for a village..." class="w-full bg-slate-50 dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg text-sm p-2 pl-9"></div>
                                <div id="tour-planning-ui" class="hidden mb-4 p-3 bg-indigo-50 dark:bg-indigo-900/50 rounded-lg">
                                    <p class="text-sm font-semibold text-indigo-800 dark:text-indigo-200 mb-2">Tour Planning Mode</p>
                                    <p class="text-xs text-slate-600 dark:text-slate-300 mb-3">Select 'Red' projects or villages on the map to add them to your tour.</p>
                                    <div id="tour-stops-list" class="text-sm space-y-1 mb-3"></div>
                                    <button id="generate-route-btn" class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg text-sm disabled:bg-gray-400" disabled>Generate Optimized Route</button>
                                    <button id="cancel-tour-btn" class="w-full mt-2 text-center text-xs text-slate-500 hover:underline">Cancel</button>
                                </div>
                                <button id="plan-tour-btn" class="w-full flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold px-3 py-2 rounded-lg text-sm hover:bg-indigo-700 mb-4">
                                    <i data-lucide="route" class="w-4 h-4"></i>Plan My Tour
                                </button>
                                <h4 class="font-semibold text-slate-700 dark:text-gray-200 mb-2">Layer Control</h4>
                                <div class="space-y-2 text-sm">
                                    <label class="flex items-center"><input type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"> <span class="ml-2 text-slate-600 dark:text-gray-300">Villages (by Health)</span></label>
                                    <label class="flex items-center"><input type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"> <span class="ml-2 text-slate-600 dark:text-gray-300">Projects (by Status)</span></label>
                                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"> <span class="ml-2 text-slate-600 dark:text-gray-300">Implementing Agencies</span></label>
                                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"> <span class="ml-2 text-slate-600 dark:text-gray-300">Field Officer Zones</span></label>
                                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"> <span class="ml-2 text-slate-600 dark:text-gray-300">Grievance Heatmap</span></label>
                                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"> <span class="ml-2 text-slate-600 dark:text-gray-300">AI-Predicted Risk Zones</span></label>
                                </div>
                            </div>
                            <!-- Map View -->
                            <div class="flex-grow h-64 md:h-auto rounded-lg shadow-md relative bg-slate-200 dark:bg-gray-800">
                                <div id="map" class="w-full h-full rounded-lg"></div>
                                <!-- Intelligence Dossier Pane -->
                                <div id="map-dossier-pane" class="absolute top-0 right-0 h-full w-80 bg-white dark:bg-[#1c1b1a] shadow-2xl transform translate-x-full z-10 overflow-y-auto p-4">
                                   <div id="map-dossier-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                 `;
                 initializeMap();
                 attachThemeToggleListener();
                 lucide.createIcons();
            }

            function renderTeamPerformance() {
                mainContent.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6"><div><h2 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-gray-100">Team Performance</h2><p class="text-slate-500 dark:text-gray-400 mt-1 text-sm sm:text-base">Strategic overview of your squad's readiness.</p></div><div class="flex items-center mt-4 sm:mt-0 w-full sm:w-auto justify-end"><button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="sun" id="theme-toggle-light-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i><i data-lucide="moon" id="theme-toggle-dark-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400 hidden"></i></button></div></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Total Field Officers</h3><p class="text-4xl font-bold text-slate-800 dark:text-gray-100 mt-2">8</p></div>
                        <div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Block-wide Data Quality</h3><p class="text-4xl font-bold text-green-600 dark:text-green-500 mt-2">92%</p></div>
                        <div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">On-Time Submission Rate</h3><p class="text-4xl font-bold text-green-600 dark:text-green-500 mt-2">88%</p></div>
                        <div class="card p-5"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Training Modules Assigned</h3><p class="text-4xl font-bold text-yellow-600 dark:text-yellow-500 mt-2">3</p></div>
                    </div>
                     <div class="card p-4 mb-6"><div class="flex flex-wrap items-center justify-between gap-4"><div class="flex-grow max-w-sm"><div class="relative"><i data-lucide="search" class="w-4 h-4 absolute top-1/2 left-3 -translate-y-1/2 text-slate-400"></i><input type="text" placeholder="Search for an officer..." class="w-full bg-slate-50 dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg text-sm p-2 pl-9"></div></div><div class="flex items-center gap-2 flex-wrap"><button class="px-3 py-1.5 text-sm font-medium text-slate-700 dark:text-gray-200 bg-slate-100 dark:bg-gray-700 rounded-lg">All</button><button class="px-3 py-1.5 text-sm font-medium text-yellow-700 dark:text-yellow-300 bg-yellow-100 dark:bg-yellow-900/50 rounded-lg">Needs Support</button><button class="px-3 py-1.5 text-sm font-medium text-green-700 dark:text-green-300 bg-green-100 dark:bg-green-900/50 rounded-lg">High Performers</button><button class="px-3 py-1.5 text-sm font-medium text-red-700 dark:text-red-300 bg-red-100 dark:bg-red-900/50 rounded-lg">Overloaded</button></div><div><select class="bg-slate-50 dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg text-sm p-2"><option>Sort by: Data Quality (Low to High)</option><option>Sort by: Timeliness</option><option>Sort by: Workload</option></select></div></div></div>
                     <div id="officer-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                `;
                populateOfficerGrid();
                attachThemeToggleListener();
            }

            function renderCommunicationHub() {
                 mainContent.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-gray-100">Communication Hub</h2>
                            <p class="text-slate-500 dark:text-gray-400 mt-1 text-sm sm:text-base">Your tactical interface for directed action.</p>
                        </div>
                         <div class="flex items-center mt-4 sm:mt-0">
                            <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                                <i data-lucide="sun" id="theme-toggle-light-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i>
                                <i data-lucide="moon" id="theme-toggle-dark-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400 hidden"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card h-[calc(100vh-12rem)] flex overflow-hidden">
                        <!-- Left Column: Channels -->
                        <div id="comm-channels" class="w-1/3 md:w-1/4 border-r border-slate-200 dark:border-gray-700 flex flex-col">
                            <div class="p-4 flex-shrink-0">
                                <h3 class="font-bold text-lg text-slate-800 dark:text-gray-100">Channels</h3>
                            </div>
                            <div class="px-2 py-2 overflow-y-auto">
                                <h4 class="px-2 text-xs font-bold uppercase text-slate-400 mb-2">General</h4>
                                <a href="#" data-channel-id="announcements" class="channel-link flex items-center px-2 py-1.5 text-sm text-slate-700 dark:text-gray-200 rounded-lg active">
                                    <i data-lucide="hash" class="w-4 h-4 mr-2"></i> block-announcements
                                </a>
                                 <h4 class="px-2 mt-4 text-xs font-bold uppercase text-slate-400 mb-2">Direct Messages</h4>
                                <a href="#" data-channel-id="dm-sunil" class="channel-link flex items-center px-2 py-1.5 text-sm text-slate-600 dark:text-gray-300 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-800">
                                    <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Sunil Kumar
                                </a>
                                 <a href="#" data-channel-id="dm-anita" class="channel-link flex items-center px-2 py-1.5 text-sm text-slate-600 dark:text-gray-300 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-800">
                                    <span class="w-2 h-2 rounded-full bg-slate-400 mr-2"></span> Anita Singh
                                </a>
                                <h4 class="px-2 mt-4 text-xs font-bold uppercase text-slate-400 mb-2">Contextual</h4>
                                <a href="#" data-channel-id="vdp-rampur" class="channel-link flex items-center px-2 py-1.5 text-sm text-slate-600 dark:text-gray-300 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-800">
                                    <i data-lucide="file-text" class="w-4 h-4 mr-2"></i> VDP-Review_Rampur
                                </a>
                                 <a href="#" data-channel-id="proj-sitapur" class="channel-link flex items-center px-2 py-1.5 text-sm text-slate-600 dark:text-gray-300 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-800">
                                    <i data-lucide="construction" class="w-4 h-4 mr-2"></i> Proj_CommHall_Sitapur
                                </a>
                                 <a href="#" data-channel-id="grievance-123" class="channel-link flex items-center px-2 py-1.5 text-sm text-slate-600 dark:text-gray-300 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-800">
                                    <i data-lucide="siren" class="w-4 h-4 mr-2"></i> Grievance_#12345
                                </a>
                            </div>
                        </div>
                        <!-- Right Column: Feed -->
                        <div class="flex-1 flex flex-col">
                           <div id="comm-feed-header" class="p-4 border-b border-slate-200 dark:border-gray-700 flex-shrink-0">
                                <!-- Header will be populated by JS -->
                           </div>
                           <div id="comm-feed-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                                <!-- Messages will be populated by JS -->
                           </div>
                           <div class="p-4 border-t border-slate-200 dark:border-gray-700 flex-shrink-0">
                               <div class="relative">
                                   <textarea id="comm-message-input" class="w-full bg-slate-100 dark:bg-gray-800 rounded-lg p-3 pr-28 text-sm" rows="1" placeholder="Type your message..."></textarea>
                                   <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1">
                                       <button class="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="paperclip" class="w-5 h-5 text-slate-500"></i></button>
                                       <button id="create-task-btn" class="flex items-center gap-1.5 bg-red-600 text-white font-semibold px-3 py-1.5 rounded-lg text-sm hover:bg-red-700">
                                           <i data-lucide="zap" class="w-4 h-4"></i>!
                                       </button>
                                   </div>
                               </div>
                           </div>
                        </div>
                    </div>
                 `;
                 populateCommunicationHub();
                 attachThemeToggleListener();
            }

            function renderReports() {
                 mainContent.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-gray-100">Reports</h2>
                            <p class="text-slate-500 dark:text-gray-400 mt-1 text-sm sm:text-base">Generate Pre-Formatted Briefings for Official Review</p>
                        </div>
                        <div class="flex items-center mt-4 sm:mt-0">
                            <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                                <i data-lucide="sun" id="theme-toggle-light-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i>
                                <i data-lucide="moon" id="theme-toggle-dark-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400 hidden"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Card 1: Weekly Block Summary -->
                        <div class="card p-5 flex flex-col">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-gray-100">Weekly Block Summary</h3>
                            <p class="text-sm text-slate-500 dark:text-gray-400 flex-grow my-2">The standard, comprehensive report for the weekly district review meeting.</p>
                            <button class="generate-report-btn w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg text-sm hover:bg-indigo-700">Generate Weekly Summary</button>
                        </div>
                         <!-- Card 2: Red Flag Report -->
                        <div class="card p-5 flex flex-col border-2 border-red-500/50">
                            <h3 class="font-bold text-lg text-red-600 dark:text-red-400">Red Flag Report</h3>
                            <p class="text-sm text-slate-500 dark:text-gray-400 flex-grow my-2">A high-urgency briefing that focuses exclusively on problems.</p>
                            <button class="generate-report-btn w-full bg-red-600 text-white font-semibold py-2 rounded-lg text-sm hover:bg-red-700">Generate Red Flag Report</button>
                        </div>
                         <!-- Card 3: Project Evidence Package -->
                        <div class="card p-5 flex flex-col">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-gray-100">Project Evidence Package</h3>
                            <p class="text-sm text-slate-500 dark:text-gray-400 flex-grow my-2">Provide undeniable, ground-truth evidence for a specific project's progress.</p>
                            <button id="generate-evidence-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg text-sm hover:bg-indigo-700">Generate Evidence Package</button>
                        </div>
                        <!-- Card 4: Social Audit Action Tracker -->
                        <div class="card p-5 flex flex-col">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-gray-100">Social Audit Action Tracker</h3>
                            <p class="text-sm text-slate-500 dark:text-gray-400 flex-grow my-2">Prove that the community's voice is being heard and acted upon.</p>
                            <button class="generate-report-btn w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg text-sm hover:bg-indigo-700">Generate Social Audit Tracker</button>
                        </div>
                        <!-- Card 5: Custom Data Export -->
                        <div class="card p-5 flex flex-col md:col-span-2">
                             <h3 class="font-bold text-lg text-slate-800 dark:text-gray-100">Custom Data Export</h3>
                            <p class="text-sm text-slate-500 dark:text-gray-400 flex-grow my-2">For when a simple PDF isn't enough and raw data is needed for deeper analysis.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                                <div><label class="text-xs text-slate-500">Date Range</label><select class="w-full bg-slate-100 dark:bg-gray-800 rounded p-2 mt-1 text-sm"><option>Last 7 Days</option><option>Last 30 Days</option><option>Custom</option></select></div>
                                <div><label class="text-xs text-slate-500">Data Type</label><select class="w-full bg-slate-100 dark:bg-gray-800 rounded p-2 mt-1 text-sm"><option>Projects</option><option>Villages</option><option>Grievances</option></select></div>
                                <div><label class="text-xs text-slate-500">Format</label><select class="w-full bg-slate-100 dark:bg-gray-800 rounded p-2 mt-1 text-sm"><option>CSV</option><option>Excel</option></select></div>
                            </div>
                            <button class="generate-report-btn w-full bg-green-600 text-white font-semibold py-2 rounded-lg text-sm hover:bg-green-700">Export Raw Data</button>
                        </div>
                    </div>
                `;
                document.getElementById('generate-evidence-btn').addEventListener('click', () => openModal('report'));
                attachThemeToggleListener();
            }

            // --- DATA POPULATION FUNCTIONS ---
            
            async function populateDashboardData() {
                await Promise.all([populateTaskInbox(), populateVillageHealth(), populateAIOpportunities(), populateTeamPulse()]);
                createCharts(isDarkMode);
                lucide.createIcons();
            }

            async function populateTaskInbox() {
                const prompt = { contents: [{ parts: [{ text: "Get Task Inbox data with AI scores." }] }] };
                const response = await callGeminiAPI(prompt);
                const tasks = JSON.parse(response.candidates[0].content.parts[0].text);
                const tbody = document.getElementById('task-inbox-body');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                tasks.forEach(task => {
                    let scoreColor = 'text-green-600 dark:text-green-400';
                    if (task.aiScore < 80) scoreColor = 'text-yellow-600 dark:text-yellow-400';
                    if (task.aiScore < 70) scoreColor = 'text-red-600 dark:text-red-400';

                    const row = `
                        <tr class="bg-white dark:bg-[#1c1b1a] border-b dark:border-gray-700 hover:bg-slate-50 dark:hover:bg-gray-800">
                            <td class="px-6 py-4"><div class="font-medium text-slate-900 dark:text-gray-100">${task.type}</div><div class="text-xs text-slate-500">${task.village}</div></td>
                            <td class="px-6 py-4 dark:text-gray-300">${task.submittedBy}</td>
                            <td class="px-6 py-4"><div class="font-bold ${scoreColor}">${task.aiScore}%</div><div class="text-xs text-slate-500">${task.aiSummary}</div></td>
                            <td class="px-6 py-4 text-center"><button class="bg-indigo-600 text-white px-3 py-1 rounded-md text-xs font-semibold hover:bg-indigo-700">Review</button></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
             async function populateVillageHealth() {
                const prompt = { contents: [{ parts: [{ text: "Get Village Health predictive status." }] }] };
                const response = await callGeminiAPI(prompt);
                const healthData = JSON.parse(response.candidates[0].content.parts[0].text);
                const container = document.getElementById('village-health-status');
                if (!container) return;

                const statuses = [
                    { status: 'On Track', data: healthData.onTrack, color: 'green-500', icon: 'trending-up' },
                    { status: 'Minor Delays', data: healthData.minorDelays, color: 'yellow-500', icon: 'trending-down' },
                    { status: 'Critical Delays', data: healthData.criticalDelays, color: 'red-500', icon: 'alert-triangle' }
                ];
                
                container.innerHTML = statuses.map(s => `
                    <div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><span class="w-3 h-3 bg-${s.color} rounded-full mr-3"></span><h4 class="font-medium text-slate-700 dark:text-gray-200">${s.status}</h4></div>
                            <p class="text-2xl font-bold text-slate-800 dark:text-gray-100">${s.data.count}</p>
                        </div>
                        ${s.data.alert ? `<p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1 ml-6 flex items-center"><i data-lucide="${s.icon}" class="w-3 h-3 mr-1"></i>${s.data.alert}</p>` : ''}
                    </div>
                `).join('');
            }
             async function populateAIOpportunities() {
                const prompt = { contents: [{ parts: [{ text: "Get AI Opportunities." }] }] };
                const response = await callGeminiAPI(prompt);
                const opportunities = JSON.parse(response.candidates[0].content.parts[0].text);
                const container = document.getElementById('ai-opportunities');
                if (!container) return;
                
                container.innerHTML = opportunities.map(opp => `
                    <div class="bg-indigo-50 dark:bg-indigo-500/10 p-3 rounded-lg">
                        <p class="text-sm font-semibold text-indigo-800 dark:text-indigo-300">${opp.title}</p>
                        <p class="text-xs text-slate-600 dark:text-slate-400">${opp.details}</p>
                        <button class="mt-2 text-xs bg-indigo-600 text-white px-2 py-1 rounded-md font-semibold hover:bg-indigo-700">Propose ${opp.type}</button>
                    </div>
                `).join('');
            }
            async function populateTeamPulse() {
                 const prompt = { contents: [{ parts: [{ text: "Get Field Team Pulse." }] }] };
                const response = await callGeminiAPI(prompt);
                const pulses = JSON.parse(response.candidates[0].content.parts[0].text);
                const container = document.getElementById('team-pulse');
                if(!container) return;

                const pulseColors = { critical: 'red', warning: 'yellow', info: 'blue' };

                container.innerHTML = pulses.map(p => `
                    <div class="flex items-start">
                         <i data-lucide="user-cog" class="w-4 h-4 mr-3 mt-1 text-${pulseColors[p.type]}-500"></i>
                        <div>
                             <p class="font-semibold text-sm text-slate-800 dark:text-gray-200">${p.officer}</p>
                             <p class="text-xs text-${pulseColors[p.type]}-600 dark:text-${pulseColors[p.type]}-400">${p.alert}</p>
                        </div>
                    </div>
                `).join('');
            }
            function populateInboxTasks() {
                 const tbody = document.getElementById('inbox-task-body');
                 if (!tbody) return;
                 
                 const tasks = [
                    { score: '98%', scoreColor: 'text-green-600 dark:text-green-400', type: 'VDP Review', subject: 'VDP for Gopalganj', from: 'F.O. Anita Singh', date: '11-Oct-25', status: 'New', statusColor: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300', action: 'Review VDP', actionType: 'vdp' },
                    { priority: '!', priorityColor: 'text-red-600 dark:text-red-400', type: 'Grievance', subject: 'Broken Handpump', from: 'Public Portal', date: '11-Oct-25', status: 'High Priority', statusColor: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300', action: 'View & Assign', actionType: 'grievance' },
                    { score: '72%', scoreColor: 'text-yellow-600 dark:text-yellow-400', type: 'VDP Review', subject: 'VDP for Sitapur', from: 'F.O. Sunil Kumar', date: '10-Oct-25', status: 'New', statusColor: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300', action: 'Review VDP', actionType: 'vdp' },
                    { score: '', type: 'Photo Verification', subject: 'Milestone: Walls Built', from: 'F.O. Anita Singh', date: '10-Oct-25', status: 'New', statusColor: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300', action: 'Verify Photo', actionType: 'photo'},
                    { score: '', type: 'Status Update', subject: 'VDP for Rampur', from: 'System', date: '09-Oct-25', status: 'Pending at Gram Sabha', statusColor: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300', action: ''}
                 ];

                 tbody.innerHTML = tasks.map(task => `
                    <tr class="bg-white dark:bg-[#1c1b1a] border-b dark:border-gray-700 hover:bg-slate-50 dark:hover:bg-gray-800">
                        <td class="px-6 py-4 font-bold ${task.score ? task.scoreColor : task.priorityColor}">${task.score || task.priority}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full bg-slate-100 dark:bg-gray-700 text-slate-600 dark:text-gray-300">${task.type}</span></td>
                        <td class="px-6 py-4"><div class="font-medium text-slate-900 dark:text-gray-100">${task.subject}</div></td>
                        <td class="px-6 py-4 dark:text-gray-300">${task.from}</td>
                        <td class="px-6 py-4 dark:text-gray-300">${task.date}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${task.statusColor}">${task.status}</span></td>
                        <td class="px-6 py-4">
                            ${task.action ? `<button data-action-type="${task.actionType}" class="action-btn bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded-md text-xs font-semibold hover:bg-indigo-200 dark:hover:bg-indigo-900">${task.action}</button>` : ''}
                        </td>
                    </tr>
                 `).join('');
                 
                 document.querySelectorAll('.action-btn').forEach(btn => btn.addEventListener('click', (e) => openActionPane(e.currentTarget.dataset.actionType)));
                 lucide.createIcons();
            }

            function populateVillageGrid() {
                const villages = [
                    { name: 'Rampur', status: 'red', score: 42, vdpStatus: 'Pending at Gram Sabha', projects: 3, grievances: 2, flags: ['delay', 'finance', 'complaints'], updated: '2 hours ago' },
                    { name: 'Gopalganj', status: 'amber', score: 68, vdpStatus: 'Pending at BDO', projects: 5, grievances: 1, flags: ['delay'], updated: '5 hours ago' },
                    { name: 'Sitapur', status: 'green', score: 95, vdpStatus: 'Approved', projects: 4, grievances: 0, flags: [], updated: '1 day ago' },
                    { name: 'Alipur', status: 'green', score: 88, vdpStatus: 'Approved', projects: 6, grievances: 0, flags: [], updated: '2 days ago' },
                    { name: 'Mohanpur', status: 'amber', score: 71, vdpStatus: 'Pending at Gram Sabha', projects: 2, grievances: 3, flags: ['complaints'], updated: '3 hours ago' },
                    { name: 'Kadipur', status: 'red', score: 51, vdpStatus: 'VDP Generated', projects: 1, grievances: 5, flags: ['delay', 'complaints'], updated: '1 hour ago' },
                ];
                const grid = document.getElementById('village-grid');
                if (!grid) return;

                const statusColors = { red: 'bg-red-500', amber: 'bg-yellow-500', green: 'bg-green-500' };
                const flagIcons = { 
                    delay: '<i data-lucide="clock" class="w-4 h-4 text-yellow-600" title="Project Delays"></i>', 
                    finance: '<i data-lucide="siren" class="w-4 h-4 text-red-600" title="Financial Issues"></i>', 
                    complaints: '<i data-lucide="users" class="w-4 h-4 text-blue-600" title="High Beneficiary Complaints"></i>' 
                };
                
                grid.innerHTML = villages.map(v => `
                    <div class="card overflow-hidden flex flex-col">
                        <div class="h-1.5 ${statusColors[v.status]}"></div>
                        <div class="p-5 flex-grow flex flex-col">
                            <div class="flex justify-between items-start">
                                <h3 class="text-lg font-bold text-slate-800 dark:text-gray-100">${v.name}</h3>
                                <div class="px-2 py-1 rounded-md bg-slate-100 dark:bg-gray-800 text-sm font-bold text-slate-800 dark:text-gray-100">${v.score}<span class="font-normal text-slate-500">/100</span></div>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-gray-400 mb-4">Performance Score</p>
                            <div class="grid grid-cols-3 gap-4 text-center mb-4">
                                <div><p class="text-lg font-semibold text-slate-700 dark:text-gray-200">${v.projects}</p><p class="text-xs text-slate-500">Projects</p></div>
                                <div><p class="text-lg font-semibold text-slate-700 dark:text-gray-200">${v.grievances}</p><p class="text-xs text-slate-500">Grievances</p></div>
                                <div><p class="text-sm font-semibold text-indigo-600 dark:text-indigo-400">${v.vdpStatus.split(' ')[0]}</p><p class="text-xs text-slate-500">VDP Status</p></div>
                            </div>
                            <div class="mt-auto">
                                <div class="flex justify-between items-center bg-slate-50 dark:bg-gray-800 p-2 rounded-lg">
                                    <div class="flex items-center gap-2"><p class="text-xs font-semibold text-slate-600 dark:text-gray-300">Flags:</p><div class="flex gap-2">${v.flags.map(f => flagIcons[f]).join('') || '<span class="text-xs text-slate-400">None</span>'}</div></div>
                                    <p class="text-xs text-slate-400">${v.updated}</p>
                                </div>
                                <button data-village-name="${v.name}" class="view-dossier-btn mt-4 w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg text-sm hover:bg-indigo-700">View Dossier</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.querySelectorAll('.view-dossier-btn').forEach(btn => btn.addEventListener('click', e => openVillageDossier(e.currentTarget.dataset.villageName)));
                lucide.createIcons();
            }

            function populateOfficerGrid() {
                 const officers = [
                    { id: 1, name: 'Sunil Kumar', photo: 'https://placehold.co/80x80/E2E8F0/475569?text=SK', quality: 78, timeliness: 95, workload: 15, pulse: 'High rate of VDPs being returned for correction.', pulseType: 'critical' },
                    { id: 2, name: 'Anita Singh', photo: 'https://placehold.co/80x80/E2E8F0/475569?text=AS', quality: 98, timeliness: 99, workload: 12, pulse: 'Top performer in data quality.', pulseType: 'info' },
                    { id: 3, name: 'Rajesh Verma', photo: 'https://placehold.co/80x80/E2E8F0/475569?text=RV', quality: 91, timeliness: 85, workload: 18, pulse: 'Workload 20% above block average.', pulseType: 'warning' },
                    { id: 4, name: 'Priya Sharma', photo: 'https://placehold.co/80x80/E2E8F0/475569?text=PS', quality: 95, timeliness: 92, workload: 14, pulse: 'Consistent high performer.', pulseType: 'info' }
                ];
                const grid = document.getElementById('officer-grid');
                if (!grid) return;

                const getPerfColor = (value) => value > 90 ? 'text-green-600 dark:text-green-400' : value > 80 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400';
                const pulseColors = { critical: 'text-red-600 dark:text-red-400', warning: 'text-yellow-600 dark:text-yellow-400', info: 'text-blue-600 dark:text-blue-400' };

                grid.innerHTML = officers.map(o => `
                    <div class="card p-5 text-center flex flex-col">
                        <img src="${o.photo}" class="w-20 h-20 rounded-full mx-auto mb-4" alt="${o.name}">
                        <h3 class="font-bold text-lg text-slate-800 dark:text-gray-100">${o.name}</h3>
                        <div class="grid grid-cols-3 gap-2 my-4">
                            <div><p class="text-2xl font-bold ${getPerfColor(o.quality)}">${o.quality}%</p><p class="text-xs text-slate-500">Data Quality</p></div>
                            <div><p class="text-2xl font-bold ${getPerfColor(o.timeliness)}">${o.timeliness}%</p><p class="text-xs text-slate-500">Timeliness</p></div>
                            <div><p class="text-2xl font-bold text-slate-700 dark:text-gray-200">${o.workload}</p><p class="text-xs text-slate-500">Villages</p></div>
                        </div>
                        <div class="bg-slate-50 dark:bg-gray-800 p-3 rounded-lg text-left mt-auto">
                            <p class="text-xs font-semibold text-slate-600 dark:text-gray-300 flex items-center"><i data-lucide="activity" class="w-4 h-4 mr-2"></i>AI Field Pulse</p>
                            <p class="text-xs mt-1 ${pulseColors[o.pulseType]}">${o.pulse}</p>
                        </div>
                        <button data-officer-id="${o.id}" class="view-officer-dossier-btn mt-4 w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg text-sm hover:bg-indigo-700">View Dossier</button>
                    </div>
                `).join('');
                document.querySelectorAll('.view-officer-dossier-btn').forEach(btn => btn.addEventListener('click', e => openOfficerDossier(e.currentTarget.dataset.officerId)));
                lucide.createIcons();
            }

            function populateCommunicationHub() {
                const channels = document.querySelectorAll('.channel-link');
                const feedHeader = document.getElementById('comm-feed-header');
                const feedMessages = document.getElementById('comm-feed-messages');
                const messageInput = document.getElementById('comm-message-input');
                const createTaskBtn = document.getElementById('create-task-btn');

                const messageData = {
                    'announcements': {
                        name: '# block-announcements',
                        description: 'Official orders, circulars, and updates.',
                        messages: [
                            { type: 'system', text: 'VDP submission deadline for Q3 is 15-Oct-2025.' },
                            { type: 'user', user: 'Alok Verma', text: 'All Field Officers: Please ensure your weekly reports are submitted by EOD today.', time: '10:30 AM' },
                        ]
                    },
                    'vdp-rampur': {
                         name: '# VDP-Review_Rampur',
                        description: 'All communication regarding the Rampur VDP.',
                        messages: [
                             { type: 'system', text: 'VDP for Rampur Village has been submitted by F.O. Sunil Kumar and is awaiting your review. <a href="#" class="text-indigo-500 underline">Click here to review</a>' },
                             { type: 'user', user: 'Alok Verma', text: '@Sunil Kumar, please get an updated photo of the Sitapur road by Friday.', time: '11:00 AM' },
                        ]
                    }
                };
                
                function loadChannel(channelId) {
                    const data = messageData[channelId] || { name: 'Unknown Channel', description: '', messages: [] };
                    feedHeader.innerHTML = `<h4 class="font-bold text-lg text-slate-800 dark:text-gray-100">${data.name}</h4><p class="text-xs text-slate-500">${data.description}</p>`;
                    feedMessages.innerHTML = data.messages.map(msg => {
                        if (msg.type === 'system') {
                             return `<div class="text-center text-xs text-slate-400 my-2">${msg.text}</div>`;
                        }
                        return `
                            <div class="flex items-start gap-3">
                                <img src="https://placehold.co/40x40/E2E8F0/475569?text=AV" class="w-10 h-10 rounded-full" />
                                <div>
                                    <p class="font-semibold text-slate-800 dark:text-gray-100">${msg.user} <span class="text-xs font-normal text-slate-400">${msg.time}</span></p>
                                    <div class="mt-1 text-slate-700 dark:text-gray-300">${msg.text}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    feedMessages.scrollTop = feedMessages.scrollHeight;
                }

                channels.forEach(channel => {
                    channel.addEventListener('click', (e) => {
                        e.preventDefault();
                        channels.forEach(c => c.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        loadChannel(e.currentTarget.dataset.channelId);
                    });
                });
                
                createTaskBtn.addEventListener('click', () => {
                     const messageText = messageInput.value;
                    if (!messageText) return;

                    const systemMessage = `
                         <div class="text-center text-xs text-slate-400 my-2">BDO Alok Verma has assigned the task "${messageText.replace('@Sunil Kumar,', '').trim()}" to F.O. Sunil Kumar.</div>
                    `;
                    feedMessages.innerHTML += systemMessage;
                    feedMessages.scrollTop = feedMessages.scrollHeight;
                    messageInput.value = '';
                });

                loadChannel('announcements'); // Load default channel
                lucide.createIcons();
            }

            // --- ACTION PANE & DOSSIER LOGIC ---
            const actionPaneContainer = document.getElementById('action-pane-container');
            const actionPane = document.getElementById('action-pane');
            const actionPaneContent = document.getElementById('action-pane-content');
            const villageDossierContainer = document.getElementById('village-dossier-container');
            const villageDossierContent = document.getElementById('village-dossier-content');
            const officerDossierContainer = document.getElementById('officer-dossier-container');
            const officerDossierContent = document.getElementById('officer-dossier-content');
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');


            function openActionPane(type) {
                let content = '';
                if(type === 'vdp') {
                     content = `
                        <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800 dark:text-gray-100">VDP Review: Gopalganj</h3><button id="close-pane-btn" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                        <div class="bg-indigo-50 dark:bg-indigo-500/10 p-4 rounded-lg mb-4"><h4 class="font-semibold text-indigo-800 dark:text-indigo-300">AI Analysis</h4><p class="text-sm text-slate-700 dark:text-slate-300 mt-1">All data present. Budget is consistent with similar projects.</p></div>
                        <p class="text-slate-600 dark:text-gray-400 mb-4">View submitted data and the auto-generated VDP PDF.</p>
                        <div class="space-y-4"><button class="w-full text-left p-3 bg-slate-100 dark:bg-gray-800 rounded-lg">View Submitted Data</button><button class="w-full text-left p-3 bg-slate-100 dark:bg-gray-800 rounded-lg">View VDP PDF</button></div>
                        <div class="mt-8 pt-4 border-t border-slate-200 dark:border-gray-700 flex gap-4"><button class="flex-1 bg-green-600 text-white font-semibold py-2.5 rounded-lg">Approve & Forward</button><button class="flex-1 bg-yellow-500 text-white font-semibold py-2.5 rounded-lg">Return for Correction</button><button class="flex-1 bg-slate-200 dark:bg-gray-700 text-slate-800 dark:text-gray-200 font-semibold py-2.5 rounded-lg">Save & Close</button></div>
                     `;
                } else if (type === 'photo') {
                    content = `
                         <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800 dark:text-gray-100">Verify Photo: Walls Built</h3><button id="close-pane-btn" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                        <img src="https://placehold.co/600x400/ccc/fff?text=Milestone+Photo" alt="Milestone photo" class="w-full rounded-lg mb-4"/>
                        <p class="text-slate-600 dark:text-gray-400 mb-4">Geo-location and timestamp are verified.</p>
                        <div class="mt-8 pt-4 border-t border-slate-200 dark:border-gray-700 flex gap-4"><button class="flex-1 bg-green-600 text-white font-semibold py-2.5 rounded-lg">Verify & Forward</button><button class="flex-1 bg-yellow-500 text-white font-semibold py-2.5 rounded-lg">Reject Photo</button></div>
                    `;
                } else if (type === 'grievance') {
                    content = `
                         <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800 dark:text-gray-100">Grievance: Broken Handpump</h3><button id="close-pane-btn" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                        <div class="bg-red-50 dark:bg-red-500/10 p-4 rounded-lg mb-4"><h4 class="font-semibold text-red-800 dark:text-red-300">Details from Public Portal</h4><p class="text-sm text-slate-700 dark:text-slate-300 mt-1">"The handpump in the main square has been broken for 3 days. Please repair it urgently."</p></div>
                        <p class="text-slate-600 dark:text-gray-400 mb-4">Assign this task to a field officer for verification and resolution.</p>
                        <div class="space-y-4"><label for="assign-officer" class="text-sm font-medium text-slate-700 dark:text-gray-300">Assign to Officer:</label><select id="assign-officer" class="w-full bg-slate-100 dark:bg-gray-800 rounded-lg p-3 border border-slate-300 dark:border-gray-600"><option>F.O. Sunil Kumar</option><option>F.O. Anita Singh</option><option>Other</option></select><textarea class="w-full bg-slate-100 dark:bg-gray-800 rounded-lg p-3 border border-slate-300 dark:border-gray-600" rows="3" placeholder="Add instructions or comments..."></textarea></div>
                        <div class="mt-8 pt-4 border-t border-slate-200 dark:border-gray-700 flex gap-4"><button class="flex-1 bg-indigo-600 text-white font-semibold py-2.5 rounded-lg">Assign Task</button><button class="flex-1 bg-slate-200 dark:bg-gray-700 text-slate-800 dark:text-gray-200 font-semibold py-2.5 rounded-lg">Close</button></div>
                    `;
                }
                actionPaneContent.innerHTML = content;
                lucide.createIcons();
                actionPaneContainer.classList.remove('hidden');
                setTimeout(() => actionPane.classList.remove('translate-x-full'), 10);
                const closeBtn = document.getElementById('close-pane-btn');
                if (closeBtn) closeBtn.addEventListener('click', closeActionPane);
            }
            function closeActionPane() {
                actionPane.classList.add('translate-x-full');
                setTimeout(() => actionPaneContainer.classList.add('hidden'), 300);
            }
            actionPaneContainer.addEventListener('click', e => { if (e.target === actionPaneContainer) closeActionPane(); });

            function openVillageDossier(villageName) {
                villageDossierContent.innerHTML = `
                    <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800 dark:text-gray-100">${villageName}</h2><button id="close-dossier-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button></div>
                    <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-slate-500 dark:text-gray-400 mb-6"><span>Sarpanch: Mr. Ramesh Kumar (+91 98XXX XXXXX)</span><span>Field Officer: F.O. Sunil Kumar (+91 99XXX XXXXX)</span></div>
                    <div class="border-b border-slate-200 dark:border-gray-700"><nav id="dossier-tabs" class="flex space-x-8" aria-label="Tabs"><a href="#" class="dossier-tab active-tab py-4 px-1 text-sm font-medium">Overview & Action Plan</a><a href="#" class="dossier-tab text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 py-4 px-1 text-sm font-medium">Projects</a><a href="#" class="dossier-tab text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 py-4 px-1 text-sm font-medium">VDP Workflow</a><a href="#" class="dossier-tab text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 py-4 px-1 text-sm font-medium">Grievances</a><a href="#" class="dossier-tab text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 py-4 px-1 text-sm font-medium">Beneficiaries</a></nav></div>
                    <div id="dossier-tab-content" class="py-6">
                        <div class="bg-indigo-50 dark:bg-indigo-900/50 border border-indigo-200 dark:border-indigo-800 rounded-lg p-5 mb-6"><h3 class="text-lg font-semibold text-indigo-800 dark:text-indigo-200 flex items-center"><i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>AI-Powered Next Best Action</h3><p class="text-slate-700 dark:text-slate-300 mt-2"><b>Recommendation:</b> VDP has been pending at Gram Sabha for 12 days. The 'Red Flag' is a procedural bottleneck. <b>Action:</b> Schedule a follow-up call with the Sarpanch.</p></div>
                        <div class="card p-5"><h3 class="text-lg font-semibold text-slate-800 dark:text-gray-100 mb-4">'Adarsh Gram' Indicator Status</h3><p class="text-slate-500 dark:text-gray-400">Indicator breakdown will be shown here.</p></div>
                    </div>
                `;
                villageDossierContainer.classList.remove('translate-y-full');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
                lucide.createIcons();
                document.getElementById('close-dossier-btn').addEventListener('click', closeVillageDossier);
            }

            function closeVillageDossier() {
                villageDossierContainer.classList.add('translate-y-full');
                document.body.style.overflow = '';
            }
            
            async function openOfficerDossier(officerId) {
                const prompt = { contents: [{ parts: [{ text: `Get AI Root Cause Analysis for officer ${officerId}` }] }] };
                const response = await callGeminiAPI(prompt);
                const aiData = JSON.parse(response.candidates[0].content.parts[0].text);
            
                officerDossierContent.innerHTML = `
                    <div class="flex justify-between items-center mb-4"><h2 class="text-3xl font-bold text-slate-800 dark:text-gray-100">Officer Dossier</h2><button id="close-officer-dossier-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button></div>
                     <div class="flex items-center mb-6"><img src="https://placehold.co/80x80/E2E8F0/475569?text=SK" class="w-20 h-20 rounded-full mr-6" alt="Sunil Kumar"><div class="text-sm text-slate-500 dark:text-gray-400"><h3 class="text-2xl font-bold text-slate-800 dark:text-gray-100 mb-1">Sunil Kumar</h3><p>+91 99XXX XXXXX</p><p>Assigned Villages: Rampur, Gopalganj, Sitapur...</p></div></div>
                    <div class="border-b border-slate-200 dark:border-gray-700"><nav id="dossier-tabs" class="flex space-x-8" aria-label="Tabs"><a href="#" class="dossier-tab active-tab py-4 px-1 text-sm font-medium">Performance Analytics</a><a href="#" class="dossier-tab text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 py-4 px-1 text-sm font-medium">AI Coaching</a><a href="#" class="dossier-tab text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 py-4 px-1 text-sm font-medium">Communication</a></nav></div>
                    <div id="dossier-tab-content" class="py-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"><div class="card p-4"><h4 class="font-semibold text-slate-700 dark:text-gray-200 mb-2">Data Quality Trend</h4><div style="height: 200px;"><canvas id="qualityChart"></canvas></div></div><div class="card p-4"><h4 class="font-semibold text-slate-700 dark:text-gray-200 mb-2">Timeliness Trend</h4><div style="height: 200px;"><canvas id="timelinessChart"></canvas></div></div></div>
                        <div class="card p-4"><h4 class="font-semibold text-slate-700 dark:text-gray-200 mb-2">Recent Activity Log</h4><div class="text-sm text-slate-600 dark:text-gray-300">Log will be here...</div></div>
                        <div class="mt-6 bg-indigo-50 dark:bg-indigo-900/50 border border-indigo-200 dark:border-indigo-800 rounded-lg p-5">
                            <h3 class="text-lg font-semibold text-indigo-800 dark:text-indigo-200 flex items-center"><i data-lucide="brain-circuit" class="w-5 h-5 mr-2"></i>AI-Powered Root Cause Analysis</h3><p class="text-slate-700 dark:text-slate-300 mt-2">${aiData.analysis}</p>
                            <h3 class="text-lg font-semibold text-indigo-800 dark:text-indigo-200 flex items-center mt-4"><i data-lucide="graduation-cap" class="w-5 h-5 mr-2"></i>AI Coaching Recommendation</h3><p class="text-slate-700 dark:text-slate-300 mt-2">${aiData.recommendation}</p>
                            <button class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-indigo-700">Assign Training Module</button>
                        </div>
                    </div>
                `;
                officerDossierContainer.classList.remove('translate-y-full');
                document.body.style.overflow = 'hidden';
                createOfficerCharts(isDarkMode);
                lucide.createIcons();
                document.getElementById('close-officer-dossier-btn').addEventListener('click', closeOfficerDossier);
            }

             function closeOfficerDossier() {
                officerDossierContainer.classList.add('translate-y-full');
                document.body.style.overflow = '';
                Object.values(officerCharts).forEach(chart => chart.destroy());
                officerCharts = {};
            }
            
            function openModal(type) {
                let content = '';
                if(type === 'report') {
                    content = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-gray-100">Generate Project Evidence Package</h3>
                            <button id="close-modal-btn" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <p class="text-sm text-slate-500 dark:text-gray-400 mb-4">Select a project to generate a consolidated PDF evidence package.</p>
                        <label class="text-xs text-slate-500">Select Project</label>
                        <select class="w-full bg-slate-100 dark:bg-gray-800 rounded p-2 mt-1 text-sm">
                            <option>Community Hall, Sitapur</option>
                            <option>Skill Center, Gopalganj</option>
                            <option>Hostel Construction, Rampur</option>
                        </select>
                        <button class="mt-6 w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg text-sm hover:bg-indigo-700">Generate Package</button>
                    `;
                } else if (type === 'support') {
                    content = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-gray-100">Portal Guide</h3>
                            <button id="close-modal-btn" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="space-y-4 text-sm max-h-96 overflow-y-auto pr-2">
                           <div><strong class="text-indigo-600 dark:text-indigo-400">Dashboard:</strong><p class="text-slate-600 dark:text-gray-400">Your AI-Powered Command Center for a high-level overview of block status.</p></div>
                           <div><strong class="text-indigo-600 dark:text-indigo-400">Inbox / Tasks:</strong><p class="text-slate-600 dark:text-gray-400">A command queue to triage and act on all incoming tasks like VDP reviews, photo verifications, and grievances.</p></div>
                           <div><strong class="text-indigo-600 dark:text-indigo-400">Villages:</strong><p class="text-slate-600 dark:text-gray-400">A strategic grid of all villages. Assess village health, identify red flags, and drill down into a full "Dossier" for detailed intelligence.</p></div>
                           <div><strong class="text-indigo-600 dark:text-indigo-400">Block Map (GIS):</strong><p class="text-slate-600 dark:text-gray-400">Your geospatial intelligence platform. Overlay data layers to see patterns and plan field visits with the "Plan My Tour" feature.</p></div>
                           <div><strong class="text-indigo-600 dark:text-indigo-400">Team Performance:</strong><p class="text-slate-600 dark:text-gray-400">A real-time roster of your field officers. Track key metrics and access AI-powered coaching recommendations.</p></div>
                           <div><strong class="text-indigo-600 dark:text-indigo-400">Communication Hub:</strong><p class="text-slate-600 dark:text-gray-400">A tactical communication interface to turn conversations into trackable orders with the "! Create Task" feature.</p></div>
                           <div><strong class="text-indigo-600 dark:text-indigo-400">Reports:</strong><p class="text-slate-600 dark:text-gray-400">Your one-click arsenal for generating pre-formatted briefings for official review.</p></div>
                        </div>
                    `;
                }
                 modalContent.innerHTML = content;
                 modalContainer.classList.remove('hidden');
                 modalContainer.classList.add('flex');
                 document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                 lucide.createIcons();
            }

            function closeModal() {
                modalContainer.classList.add('hidden');
                modalContainer.classList.remove('flex');
            }


            // --- MAP SPECIFIC LOGIC ---
            function initializeMap() {
                const mapElement = document.getElementById('map');
                if (!mapElement || typeof L === 'undefined') {
                    mapElement.innerHTML = `<div class="flex items-center justify-center h-full text-slate-500"><p>Map could not be loaded.</p></div>`;
                    return;
                }
                if (map) { map.remove(); }

                map = L.map('map').setView([28.6139, 77.2090], 11);
                updateMapTiles();
                
                // Sample project markers
                const projects = [
                    { position: [28.63, 77.22], title: 'Community Hall', status: 'Delayed', type: 'Adarsh Gram' },
                    { position: [28.65, 77.18], title: 'Skill Center', status: 'Critical', type: 'GIA' },
                    { position: [28.58, 77.25], title: 'Hostel Construction', status: 'On Track', type: 'Hostel' }
                ];
                
                const statusColors = { 'On Track': 'border-green-500', 'Delayed': 'border-yellow-500', 'Critical': 'border-red-500' };
                const typeColors = { 'Adarsh Gram': 'bg-blue-500', 'GIA': 'bg-orange-500', 'Hostel': 'bg-purple-500' };

                projects.forEach(project => {
                    const iconHtml = `<div class="w-5 h-5 ${typeColors[project.type]} rounded-full border-2 ${statusColors[project.status]} shadow-lg"></div>`;
                    const customIcon = L.divIcon({
                        html: iconHtml,
                        className: '', // No default class
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    const marker = L.marker(project.position, { icon: customIcon, projectData: project }).addTo(map);

                    marker.on('click', () => {
                        if (isTourPlanningActive && project.status === 'Critical') {
                            toggleTourStop(marker);
                        } else if (!isTourPlanningActive) {
                            openMapDossier('project', marker.options.projectData);
                        }
                    });
                });
                
                document.getElementById('plan-tour-btn').addEventListener('click', startTourPlanning);
                document.getElementById('cancel-tour-btn').addEventListener('click', cancelTourPlanning);
                document.getElementById('generate-route-btn').addEventListener('click', generateOptimizedRoute);
            }

            function updateMapTiles() {
                if (!map) return;
                if (currentTileLayer) {
                    map.removeLayer(currentTileLayer);
                }
                const tileUrl = isDarkMode ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                const attribution = isDarkMode ? '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' : '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
                
                currentTileLayer = L.tileLayer(tileUrl, { attribution: attribution, maxZoom: 19 });
                currentTileLayer.addTo(map);
            }

            function openMapDossier(type, data) {
                const dossierPane = document.getElementById('map-dossier-pane');
                const dossierContent = document.getElementById('map-dossier-content');
                let content = '';

                if (type === 'project') {
                    content = `
                        <button id="close-map-dossier" class="absolute top-2 right-2 p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-4 h-4"></i></button>
                        <h4 class="font-bold text-lg text-slate-800 dark:text-gray-100">${data.title}</h4>
                        <p class="text-sm font-semibold text-red-500 mb-3">${data.status}</p>
                        <img src="https://placehold.co/300x200" class="rounded-lg w-full mb-3" />
                        <p class="text-xs text-slate-500 mb-3">Agency: ABC Infra Ltd.</p>
                        <div class="space-y-2">
                             <button class="w-full text-sm bg-indigo-600 text-white font-semibold py-2 rounded-lg">View Full Timeline</button>
                             <button class="w-full text-sm bg-slate-200 dark:bg-gray-700 font-semibold py-2 rounded-lg">Contact Agency</button>
                        </div>
                    `;
                } else if (type === 'tour') {
                     content = `
                        <button id="close-map-dossier" class="absolute top-2 right-2 p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-4 h-4"></i></button>
                        <h4 class="font-bold text-lg text-slate-800 dark:text-gray-100 mb-2">Optimized Tour Plan</h4>
                        <div class="text-sm space-y-2 mb-4"> ${data.routeSummary} </div>
                        <h5 class="font-semibold mb-2">Digital Dossier:</h5>
                        <div class="text-xs space-y-2">${data.dossier}</div>
                        <button class="mt-4 w-full bg-green-600 text-white font-semibold py-2 rounded-lg text-sm">Download for Tablet</button>
                     `;
                }

                dossierContent.innerHTML = content;
                dossierPane.classList.remove('translate-x-full');
                lucide.createIcons();
                document.getElementById('close-map-dossier').addEventListener('click', closeMapDossier);
            }

            function closeMapDossier() {
                document.getElementById('map-dossier-pane').classList.add('translate-x-full');
            }
            
            function startTourPlanning() {
                isTourPlanningActive = true;
                tourStops = [];
                document.getElementById('plan-tour-btn').classList.add('hidden');
                document.getElementById('tour-planning-ui').classList.remove('hidden');
                updateTourStopList();
            }

            function cancelTourPlanning() {
                isTourPlanningActive = false;
                tourStops.forEach(stop => {
                    if (stop.marker.getElement()) {
                        stop.marker.getElement().classList.remove('bouncing-marker');
                    }
                });
                tourStops = [];
                 document.getElementById('plan-tour-btn').classList.remove('hidden');
                document.getElementById('tour-planning-ui').classList.add('hidden');
            }
            
            function toggleTourStop(marker) {
                const markerElement = marker.getElement();
                if (!markerElement) return;

                const index = tourStops.findIndex(s => s.marker === marker);
                if (index > -1) {
                    markerElement.classList.remove('bouncing-marker');
                    tourStops.splice(index, 1);
                } else {
                    markerElement.classList.add('bouncing-marker');
                    tourStops.push({ marker: marker, title: marker.options.projectData.title });
                }
                updateTourStopList();
            }

            function updateTourStopList() {
                const listEl = document.getElementById('tour-stops-list');
                const generateBtn = document.getElementById('generate-route-btn');
                if (tourStops.length > 0) {
                    listEl.innerHTML = `<strong>Stops:</strong><ul class="list-disc pl-5 mt-1">${tourStops.map(s => `<li>${s.title}</li>`).join('')}</ul>`;
                    generateBtn.disabled = false;
                } else {
                    listEl.innerHTML = 'No stops selected.';
                    generateBtn.disabled = true;
                }
            }
            
            function generateOptimizedRoute() {
                if (tourStops.length < 2) {
                    alert("Please select at least two stops for a route.");
                    return;
                }
                // In a real app, you would use a routing service. Here we simulate.
                console.log("Simulating route generation for:", tourStops.map(s => s.title));
                const routeSummary = `
                    <p><strong>Route:</strong> ${tourStops.map(s => s.title).join(' -> ')}</p>
                    <p><strong>Est. Time:</strong> 2 hr 15 min</p>
                    <p><strong>Total Distance:</strong> 45 km</p>
                `;
                const dossier = tourStops.map(s => `<div class="p-2 bg-slate-100 dark:bg-gray-800 rounded"><strong>${s.title}:</strong><p class="text-xs">Project files, contacts, and checklists for this stop.</p></div>`).join('');
                openMapDossier('tour', { routeSummary, dossier });
                cancelTourPlanning(); // Exit planning mode after generation
            }


            // --- NAVIGATION LOGIC ---
            function setActiveLink(targetId) {
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    link.classList.add('text-slate-600', 'dark:text-gray-400', 'hover:bg-slate-100', 'dark:hover:bg-gray-700', 'font-medium');
                });
                const activeLink = document.getElementById(targetId);
                if (activeLink) activeLink.classList.add('active');
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = e.currentTarget.id;
                    if (!targetId) return;

                    setActiveLink(targetId);
                    
                    if (targetId === 'dashboard-link') renderDashboard();
                    else if (targetId === 'inbox-link') renderInboxTasks();
                    else if (targetId === 'villages-link') renderVillages();
                    else if (targetId === 'map-link') renderBlockMap();
                    else if (targetId === 'team-link') renderTeamPerformance();
                    else if (targetId === 'comm-link') renderCommunicationHub();
                    else if (targetId === 'reports-link') renderReports();
                    else {
                        const linkText = e.currentTarget.innerText.trim();
                        mainContent.innerHTML = `<h2 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-gray-100">${linkText} - Coming Soon</h2>`;
                    }
                });
            });

            // --- THEME & CHART LOGIC ---
            function createCharts(isDark) {
                if (pipelineChart) pipelineChart.destroy();
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : '#e2e8f0';
                const textColor = isDark ? '#9ca3af' : '#64748b';
                
                const pipelineCtx = document.getElementById('pipelineChart');
                if (!pipelineCtx) return;
                
                pipelineChart = new Chart(pipelineCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'],
                        datasets: [
                            { label: 'Received from Field', data: [15, 12, 18, 14, 20, 22], backgroundColor: '#60a5fa', borderRadius: 4 },
                            { label: 'Forwarded to District', data: [12, 11, 15, 10, 18, 19], backgroundColor: '#34d399', borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } },
                        plugins: { legend: { position: 'top', align: 'end', labels: { color: textColor } } },
                        interaction: { intersect: false, mode: 'index' }
                    }
                });
            }

            function createOfficerCharts(isDark) {
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : '#e2e8f0';
                const textColor = isDark ? '#9ca3af' : '#64748b';
                
                const qualityCtx = document.getElementById('qualityChart')?.getContext('2d');
                const timelinessCtx = document.getElementById('timelinessChart')?.getContext('2d');

                if (officerCharts.quality) officerCharts.quality.destroy();
                if (officerCharts.timeliness) officerCharts.timeliness.destroy();

                if (qualityCtx) {
                    officerCharts.quality = new Chart(qualityCtx, {
                        type: 'line',
                        data: {
                            labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'],
                            datasets: [{ label: 'Data Quality %', data: [85, 82, 88, 81, 75, 78], borderColor: '#f59e0b', tension: 0.1, fill: false }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } }, plugins: { legend: { display: false } } }
                    });
                }
                if (timelinessCtx) {
                     officerCharts.timeliness = new Chart(timelinessCtx, {
                        type: 'line',
                        data: {
                            labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'],
                            datasets: [{ label: 'Timeliness %', data: [92, 95, 96, 94, 98, 95], borderColor: '#10b981', tension: 0.1, fill: false }]
                        },
                         options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } }, plugins: { legend: { display: false } } }
                    });
                }
            }
            
            function setTheme(dark) {
                isDarkMode = dark;
                document.documentElement.classList.toggle('dark', dark);
                
                const lightIcon = document.getElementById('theme-toggle-light-icon');
                const darkIcon = document.getElementById('theme-toggle-dark-icon');
                if(lightIcon && darkIcon) {
                    lightIcon.classList.toggle('hidden', dark);
                    darkIcon.classList.toggle('hidden', !dark);
                }
                
                localStorage.setItem('theme', dark ? 'dark' : 'light');
                
                 if (document.getElementById('pipelineChart')) {
                    createCharts(dark);
                 }
                 if (document.getElementById('qualityChart')) { // If officer dossier is open
                     createOfficerCharts(dark);
                 }

                 if (document.getElementById('map')) {
                    updateMapTiles();
                 }
            };
            function attachThemeToggleListener() {
                const themeToggleBtn = document.getElementById('theme-toggle');
                if(themeToggleBtn) {
                     themeToggleBtn.addEventListener('click', () => setTheme(!document.documentElement.classList.contains('dark')));
                }
            }
            
            // --- INITIALIZATION ---
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            function toggleSidebar() { sidebar.classList.toggle('-translate-x-full'); overlay.classList.toggle('hidden'); }
            if(sidebarToggle) sidebarToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(); });
            if(overlay) overlay.addEventListener('click', toggleSidebar);

            const supportBtn = document.getElementById('contact-support-btn');
            if(supportBtn) supportBtn.addEventListener('click', () => openModal('support'));

            if(modalContainer) modalContainer.addEventListener('click', e => { if (e.target === modalContainer) closeModal(); });


            lucide.createIcons();
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('theme');
            setTheme(savedTheme === 'dark' || (savedTheme === null && prefersDark));

            setActiveLink('dashboard-link');
            renderDashboard();
        });
    </script>
</body>
</html>

